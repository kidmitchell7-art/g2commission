<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>G2 Construction Commission Tracking</title>
<style>
:root{--accent:#0077b6;--muted:#6b7280;--bg:#f6f9fc;--card:#fff;--success:#16a34a;--danger:#dc2626;}
body{margin:0;font-family:sans-serif;background:var(--bg);color:#0f172a;display:flex;justify-content:center;padding:20px;}
.container{max-width:980px;width:100%;background:var(--card);border-radius:12px;padding:20px;box-shadow:0 8px 20px rgba(0,0,0,0.1);}
header{display:flex;align-items:center;gap:16px;margin-bottom:12px;}
.logo{font-weight:800;font-size:28px;}
.logo .g{color:black;}
.logo .n2{color:var(--accent);}
h1{margin:0;font-size:22px;}
.lead{margin-top:4px;font-size:14px;color:var(--muted);}
.controls{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
input,select{padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px;width:100%;box-sizing:border-box;}
button{padding:8px 12px;border:none;border-radius:6px;background:var(--accent);color:white;cursor:pointer;font-weight:700;}
button.ghost{background:transparent;border:1px solid #ccc;color:var(--muted);}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
@media(max-width:800px){.grid{grid-template-columns:1fr;}}
.card{background:#fff;padding:14px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.result-line{display:flex;justify-content:space-between;margin:4px 0;padding:6px;border:1px solid #eee;border-radius:6px;background:#f9f9f9;}
.big{font-weight:800;}
.green{color:var(--success);}
.history-list{max-height:300px;overflow:auto;border:1px solid #eee;border-radius:6px;padding:6px;margin-top:6px;}
.history-item{display:flex;justify-content:space-between;padding:6px;border-radius:6px;margin-bottom:6px;background:#fff;}
.small-button{padding:4px 6px;font-size:12px;border-radius:4px;}
.edit-btn,.delete-btn{margin-left:4px;padding:2px 6px;font-size:11px;border-radius:4px;background:#ddd;color:#000;cursor:pointer;}
</style>
</head>
<body>
<div class="container">
<header>
<div class="logo"><span class="g">G</span><span class="n2">2</span></div>
<div>
<h1><span style="color:black">G</span><span style="color:#0077b6">2</span> Construction Commission Tracking</h1>
<div class="lead">Profiles, editable job history, commission breakdown, and export.</div>
<div class="controls">
<label>Profile:</label>
<select id="profileSelect">
<option value="David">David</option>
<option value="Joseph">Joseph</option>
<option value="Sam">Sam</option>
</select>
<select id="filterSelect" style="display:none;">
<option value="all">All Profiles</option>
<option value="David">David</option>
<option value="Joseph">Joseph</option>
</select>
<button id="exportPdf" class="ghost">Export PDF</button>
<button id="exportCsv" class="ghost">Export CSV</button>
</div>
</div>
</header>

<div class="grid">
<div class="card">
<label>Job Name</label>
<input id="jobName" type="text" placeholder="e.g. Smith Residence">
<label>Sale Price</label>
<input id="sale" type="number" step="0.01" placeholder="e.g. 28706">
<label>Cost</label>
<input id="cost" type="number" step="0.01" placeholder="e.g. 20000">
<div style="display:flex;gap:6px;margin-top:6px;">
<button id="calcBtn">Calculate</button>
<button id="saveBtn" class="ghost">Save Job</button>
<button id="clearBtn" class="ghost">Clear</button>
</div>
<div style="margin-top:10px;">
<div class="result-line"><div>Sale</div><div id="rSale" class="big">$0.00</div></div>
<div class="result-line"><div>Cost</div><div id="rCost" class="big">$0.00</div></div>
<div class="result-line"><div>Profit</div><div id="rProfit" class="big">$0.00</div></div>
<div class="result-line"><div>18% Threshold</div><div id="rThresh" class="big">$0.00</div></div>
<div class="result-line"><div>Eligible Profit</div><div id="rElig" class="big">$0.00</div></div>
<div class="result-line"><div>Commission (40%)</div><div id="rComm" class="big green">$0.00</div></div>
</div>
</div>

<div class="card">
<div>
<label>Saved Jobs (<span id="currentProfile">David</span>)</label>
<input id="search" type="text" placeholder="Search jobs...">
</div>
<div style="display:flex;gap:6px;margin-top:6px;">
<button id="sortRecent" class="ghost small-button">Recent</button>
<button id="sortHigh" class="ghost small-button">High Comm</button>
<button id="sortLow" class="ghost small-button">Low Comm</button>
</div>
<div id="history" class="history-list"></div>
<div style="margin-top:10px;">
<div class="result-line"><div>Total Sales</div><div id="tSales" class="big">$0.00</div></div>
<div class="result-line"><div>Total Profit</div><div id="tProfit" class="big">$0.00</div></div>
<div class="result-line"><div>Total Commission</div><div id="tComm" class="big green">$0.00</div></div>
</div>
</div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const PROFILES=['David','Joseph','Sam'];
const BASE_PCT=0.18;
const COMM_PCT=0.4;

const profileSelect=document.getElementById('profileSelect');
const filterSelect=document.getElementById('filterSelect');
const currentProfile=document.getElementById('currentProfile');
const saleEl=document.getElementById('sale');
const costEl=document.getElementById('cost');
const jobEl=document.getElementById('jobName');
const rSale=document.getElementById('rSale');
const rCost=document.getElementById('rCost');
const rProfit=document.getElementById('rProfit');
const rThresh=document.getElementById('rThresh');
const rElig=document.getElementById('rElig');
const rComm=document.getElementById('rComm');
const historyEl=document.getElementById('history');
const searchEl=document.getElementById('search');

let editingJobId=null;

function money(n){return Number(n).toLocaleString('en-US',{style:'currency',currency:'USD'});}
function storageKey(profile){return 'g2_jobs_'+profile;}
function loadJobs(profile){return JSON.parse(localStorage.getItem(storageKey(profile))||'[]');}
function saveJobs(profile,jobs){localStorage.setItem(storageKey(profile),JSON.stringify(jobs));}
function calcFromValues(sale,cost){
sale=Number(sale)||0; cost=Number(cost)||0;
let profit=sale-cost;
let thresh=sale*BASE_PCT;
let eligible=Math.max(0,profit-thresh);
let commission=eligible*COMM_PCT;
return {sale,cost,profit,thresh,eligible,commission};
}
function updateQuickCalc(){
  const v=calcFromValues(saleEl.value,costEl.value);
  rSale.textContent=money(v.sale);
  rCost.textContent=money(v.cost);
  rProfit.textContent=money(v.profit);
  rThresh.textContent=money(v.thresh);
  rElig.textContent=money(v.eligible);
  rComm.textContent=money(v.commission);
  return v;
}
document.getElementById('calcBtn').addEventListener('click',updateQuickCalc);
[saleEl,costEl].forEach(i=>i.addEventListener('input',updateQuickCalc));
document.getElementById('clearBtn').addEventListener('click',()=>{saleEl.value='';costEl.value='';jobEl.value='';editingJobId=null;updateQuickCalc();});

// ---------- Profiles ----------
function setProfile(profile){
profileSelect.value=profile;
localStorage.setItem('g2_lastProfile',profile);
currentProfile.textContent=profile;
filterSelect.style.display=profile==='Sam'?'inline-block':'none';
renderHistory();
updateTotals();
}
profileSelect.addEventListener('change',()=>setProfile(profileSelect.value));
filterSelect.addEventListener('change',renderHistory);
(function(){let last=localStorage.getItem('g2_lastProfile')||'David'; setProfile(last);})();

// ---------- Save Job ----------
document.getElementById('saveBtn').addEventListener('click', ()=>{
  const profile = profileSelect.value;
  const v = updateQuickCalc();
  if(!jobEl.value.trim()){ alert('Please enter a Job Name.'); return; }
  let jobs = loadJobs(profile);
  if(editingJobId){
    const idx = jobs.findIndex(j=>j.id===editingJobId);
    if(idx>=0){ jobs[idx]={...jobs[idx],jobName:jobEl.value.trim(),sale:v.sale,cost:v.cost,profit:v.profit,thresh:v.thresh,eligible:v.eligible,commission:v.commission}; editingJobId=null; }
  } else {
    jobs.unshift({id:'id_'+Date.now()+'_'+Math.floor(Math.random()*9999),jobName:jobEl.value.trim(),sale:v.sale,cost:v.cost,profit:v.profit,thresh:v.thresh,eligible:v.eligible,commission:v.commission,created:new Date().toISOString()});
  }
  saveJobs(profile,jobs);
  jobEl.value=''; saleEl.value=''; costEl.value='';
  updateQuickCalc(); renderHistory(); updateTotals();
});

// ---------- Render History ----------
function renderHistory(){
  let profile = profileSelect.value;
  let jobs=[];
  if(profile==='Sam'){
    let f=filterSelect.value;
    jobs=PROFILES.filter(p=>f==='all'?true:p===f).flatMap(p=>loadJobs(p).map(j=>({...j,profile:p})));
  } else jobs=loadJobs(profile).map(j=>({...j,profile:profile}));
  const s=searchEl.value.toLowerCase();
  if(s) jobs=jobs.filter(j=>j.jobName.toLowerCase().includes(s));
  jobs.sort((a,b)=>new Date(b.created)-new Date(a.created));
  historyEl.innerHTML='';
  jobs.forEach(j=>{
    const div=document.createElement('div');
    div.className='history-item';
    div.innerHTML=`<div><strong>${j.jobName}</strong> (${j.profile}) - ${money(j.commission)}</div>
    <div>
    <button class="edit-btn">Edit</button>
    <button class="delete-btn">Delete</button>
    </div>`;
    div.querySelector('.edit-btn').addEventListener('click',()=>{editingJobId=j.id;jobEl.value=j.jobName;saleEl.value=j.sale;costEl.value=j.cost;updateQuickCalc();});
    div.querySelector('.delete-btn').addEventListener('click',()=>{if(confirm('Delete this job?')){let arr=loadJobs(j.profile);arr=arr.filter(x=>x.id!==j.id);saveJobs(j.profile,arr);renderHistory();updateTotals();}});
    historyEl.appendChild(div);
  });
}

// ---------- Totals ----------
function updateTotals(){
  let profile=profileSelect.value;
  let jobs=[];
  if(profile==='Sam'){
    let f=filterSelect.value;
    jobs=PROFILES.filter(p=>f==='all'?true:p===f).flatMap(p=>loadJobs(p));
  } else jobs=loadJobs(profile);
  let tSale=tProfit=tComm=0;
  jobs.forEach(j=>{tSale+=j.sale;tProfit+=j.profit;tComm+=j.commission;});
  document.getElementById('tSales').textContent=money(tSale);
  document.getElementById('tProfit').textContent=money(tProfit);
  document.getElementById('tComm').textContent=money(tComm);
}

// ---------- Search & Sort ----------
searchEl.addEventListener('input',renderHistory);
document.getElementById('sortRecent').addEventListener('click',()=>renderHistory());
document.getElementById('sortHigh').addEventListener('click',()=>{
  let items=[...historyEl.children].sort((a,b)=>parseFloat(b.textContent.match(/\$([\d,.]+)/)[1].replace(/,/g,''))-parseFloat(a.textContent.match(/\$([\d,.]+)/)[1].replace(/,/g,'')));
  historyEl.innerHTML=''; items.forEach(i=>historyEl.appendChild(i));
});
document.getElementById('sortLow').addEventListener('click',()=>{
  let items=[...historyEl.children].sort((a,b)=>parseFloat(a.textContent.match(/\$([\d,.]+)/)[1].replace(/,/g,''))-parseFloat(b.textContent.match(/\$([\d,.]+)/)[1].replace(/,/g,'')));
  historyEl.innerHTML=''; items.forEach(i=>historyEl.appendChild(i));
});

// ---------- PDF & CSV ----------
document.getElementById('exportPdf').addEventListener('click',()=>{
  const { jsPDF } = window.jspdf;
  let doc=new jsPDF();
  doc.setFontSize(18);
  doc.text("G2 Construction Commission Report",10,10);
  doc.setFontSize(12);
  let y=20;
  let jobs=[];
  let profile=profileSelect.value;
  if(profile==='Sam'){
    let f=filterSelect.value;
    jobs=PROFILES.filter(p=>f==='all'?true:p===f).flatMap(p=>loadJobs(p).map(j=>({...j,profile:p})));
  } else jobs=loadJobs(profile).map(j=>({...j,profile:profile}));
  jobs.forEach(j=>{
    doc.text(`${j.jobName} (${j.profile}) Sale: ${money(j.sale)}, Cost: ${money(j.cost)}, Comm: ${money(j.commission)}`,10,y); y+=6;
    if(y>280){doc.addPage();y=10;}
  });
  let tSale=tProfit=tComm=0; jobs.forEach(j=>{tSale+=j.sale;tProfit+=j.profit;tComm+=j.commission;});
  doc.text(`Totals - Sale: ${money(tSale)}, Profit: ${money(tProfit)}, Commission: ${money(tComm)}`,10,y+6);
  doc.save(`G2_Commissions_${profile}.pdf`);
});

document.getElementById('exportCsv').addEventListener('click',()=>{
  let profile=profileSelect.value;
  let jobs=[];
  if(profile==='Sam'){
    let f=filterSelect.value;
    jobs=PROFILES.filter(p=>f==='all'?true:p===f).flatMap(p=>loadJobs(p).map(j=>({...j,profile:p})));
  } else jobs=loadJobs(profile).map(j=>({...j,profile:profile}));
  let csv='Job Name,Profile,Sale,Cost,Profit,Commission\n';
  jobs.forEach(j=>{csv+=`${j.jobName},${j.profile},${j.sale},${j.cost},${j.profit},${j.commission}\n`;});
  const blob=new Blob([csv],{type:'text/csv'});
  const link=document.createElement('a');
  link.href=URL.createObjectURL(blob);
  link.download=`G2_Commissions_${profile}.csv`;
  link.click();
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>G2 Construction Commission Tracker</title>
<style>
  body { font-family: Arial, sans-serif; background:#f8f9fa; margin:0; padding:20px; }
  h1 { text-align:center; font-size:24px; margin-bottom:20px; }
  h1 span { color:blue; }
  .container { max-width:800px; margin:auto; background:white; padding:20px; border-radius:8px; box-shadow:0 0 8px rgba(0,0,0,0.1); }
  label { display:block; margin-top:10px; }
  input, select, button { width:100%; padding:8px; margin-top:5px; border:1px solid #ccc; border-radius:4px; }
  button { background:#007bff; color:white; font-weight:bold; border:none; cursor:pointer; margin-top:10px; }
  button:hover { background:#0056b3; }
  #history div { border-bottom:1px solid #eee; padding:8px 0; display:flex; justify-content:space-between; align-items:center; }
  .edit-btn, .delete-btn, .export-btn { margin-left:5px; }
  .delete-btn { background:#dc3545; }
  .edit-btn:hover { background:#5a6268; }
  .delete-btn:hover { background:#c82333; }
</style>
</head>
<body>

<h1>G<span>2</span> Construction Commission Tracker</h1>
<div class="container">
  <label>Profile:</label>
  <select id="profileSelect">
    <option value="David">David</option>
    <option value="Joseph">Joseph</option>
    <option value="Sam">Sam (View All)</option>
  </select>

  <label>Job Name:</label>
  <input type="text" id="jobName" placeholder="Enter job name">

  <label>Sold Amount:</label>
  <input type="number" id="sale" placeholder="Enter sale amount">

  <label>Cost:</label>
  <input type="number" id="cost" placeholder="Enter cost amount">

  <button id="calcBtn">Calculate Commission</button>
  <div id="results" style="margin-top:10px;font-weight:bold;"></div>

  <button id="saveBtn">Save Job</button>
  <button id="exportBtn">Export CSV</button>

  <h3>Job History</h3>
  <div id="history">Loading...</div>
</div>

<script>
let editingJobIndex = null;

// Load jobs from localStorage
function getJobs() {
  const jobs = JSON.parse(localStorage.getItem("jobs") || "[]");
  return jobs;
}

function saveJobs(jobs) {
  localStorage.setItem("jobs", JSON.stringify(jobs));
}

// Calculate commission
document.getElementById('calcBtn').addEventListener('click', () => {
  const sale = parseFloat(document.getElementById('sale').value) || 0;
  const cost = parseFloat(document.getElementById('cost').value) || 0;
  const profit = sale - cost;
  const threshold = sale * 0.18;
  const eligible = profit - threshold;
  const commission = eligible > 0 ? eligible * 0.4 : 0;
  document.getElementById('results').innerHTML = `
    Profit: $${profit.toFixed(2)}<br>
    Eligible: $${eligible.toFixed(2)}<br>
    Commission: $${commission.toFixed(2)}
  `;
});

// Save job
document.getElementById('saveBtn').addEventListener('click', () => {
  const profile = document.getElementById('profileSelect').value;
  const jobName = document.getElementById('jobName').value.trim();
  const sale = parseFloat(document.getElementById('sale').value) || 0;
  const cost = parseFloat(document.getElementById('cost').value) || 0;

  if(!jobName) return alert("Please enter a job name.");

  const profit = sale - cost;
  const threshold = sale * 0.18;
  const eligible = profit - threshold;
  const commission = eligible > 0 ? eligible * 0.4 : 0;

  const jobData = {profile, jobName, sale, cost, profit, threshold, eligible, commission, created: Date.now()};

  const jobs = getJobs();
  if(editingJobIndex !== null){
    jobs[editingJobIndex] = jobData;
    editingJobIndex = null;
  } else {
    jobs.push(jobData);
  }
  saveJobs(jobs);

  document.getElementById('jobName').value = '';
  document.getElementById('sale').value = '';
  document.getElementById('cost').value = '';
  document.getElementById('results').textContent = '';
  loadJobs();
});

// Load job history
function loadJobs() {
  const profile = document.getElementById('profileSelect').value;
  const jobs = getJobs();
  const historyEl = document.getElementById('history');
  historyEl.innerHTML = '';

  let filtered = jobs;
  if(profile !== "Sam") {
    filtered = jobs.filter(j => j.profile === profile);
  }

  if(filtered.length === 0){
    historyEl.textContent = "No jobs yet.";
    return;
  }

  filtered.sort((a,b)=> b.created - a.created);

  filtered.forEach((j,i)=>{
    const div = document.createElement('div');
    div.innerHTML = `
      <div>
        <b>${j.jobName}</b> (${j.profile})<br>
        Sale: $${j.sale.toFixed(2)} | Cost: $${j.cost.toFixed(2)} | Commission: $${j.commission.toFixed(2)}
      </div>
      <div>
        <button class="edit-btn">Edit</button>
        <button class="delete-btn">Delete</button>
      </div>
    `;
    const [editBtn, delBtn] = div.querySelectorAll('button');
    editBtn.addEventListener('click', ()=>{
      editingJobIndex = jobs.indexOf(j);
      document.getElementById('jobName').value = j.jobName;
      document.getElementById('sale').value = j.sale;
      document.getElementById('cost').value = j.cost;
      document.getElementById('results').innerHTML = `
        Profit: $${j.profit.toFixed(2)}<br>
        Eligible: $${j.eligible.toFixed(2)}<br>
        Commission: $${j.commission.toFixed(2)}
      `;
    });
    delBtn.addEventListener('click', ()=>{
      if(confirm("Delete this job?")){
        jobs.splice(jobs.indexOf(j),1);
        saveJobs(jobs);
        loadJobs();
      }
    });
    historyEl.appendChild(div);
  });
}

// Export CSV
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const jobs = getJobs();
  const profile = document.getElementById('profileSelect').value;
  let filtered = jobs;
  if(profile !== "Sam") filtered = jobs.filter(j => j.profile === profile);

  if(filtered.length===0) return alert("No jobs to export.");

  let csv = "Job Name,Profile,Sale,Cost,Profit,Eligible,Commission\n";
  filtered.forEach(j=>{
    csv += `"${j.jobName}","${j.profile}",${j.sale},${j.cost},${j.profit},${j.eligible},${j.commission}\n`;
  });

  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "G2_Commission.csv";
  a.click();
  URL.revokeObjectURL(url);
});

// Change profile
document.getElementById('profileSelect').addEventListener('change', loadJobs);

// Initial load
loadJobs();
</script>

</body>
</html>
